// Time is: 2026-02-21T15:08:10.874Z
import{connect as M}from"cloudflare:sockets";var B=e=>atob(e),V="https://nirevil.github.io/zizifn/",Y={userID:"be0ff9df-1468-41a0-8865-796d1c6800db",proxyIPs:["nima.nscl.ir:443"],scamalytics:{username:"revilseptember",apiKey:"b2fc368184deb3d8ac914bd776b8215fe899dd8fef69fbaba77511acfbdeca0d",baseUrl:"https://api12.scamalytics.com/v3/"},socks5:{enabled:!1,relayMode:!1,address:""},fromEnv(e){let t=e.PROXYIP||this.proxyIPs[Math.floor(Math.random()*this.proxyIPs.length)],[a,r="443"]=t.split(":");return{userID:e.UUID||this.userID,proxyIP:a,proxyPort:r,proxyAddress:t,scamalytics:{username:e.SCAMALYTICS_USERNAME||this.scamalytics.username,apiKey:e.SCAMALYTICS_API_KEY||this.scamalytics.apiKey,baseUrl:e.SCAMALYTICS_BASEURL||this.scamalytics.baseUrl},socks5:{enabled:!!e.SOCKS5,relayMode:e.SOCKS5_RELAY==="true"||this.socks5.relayMode,address:e.SOCKS5||this.socks5.address}}}},g={ED_PARAMS:{ed:2560,eh:"Sec-WebSocket-Protocol"},AT_SYMBOL:"@",VLESS_PROTOCOL:B("dmxlc3M="),WS_READY_STATE_OPEN:1,WS_READY_STATE_CLOSING:2};function R(e=28,t=""){let a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let s=0;s<e;s++)r+=a.charAt(Math.floor(Math.random()*a.length));return`/${r}${t?`?${t}`:""}`}var K={xray:{tls:{path:()=>R(12,"ed=2560"),security:"tls",fp:"chrome",alpn:"http/1.1",extra:{}},tcp:{path:()=>R(12,"ed=2560"),security:"none",fp:"chrome",extra:{}}},sb:{tls:{path:()=>R(18),security:"tls",fp:"chrome",alpn:"http/1.1",extra:g.ED_PARAMS},tcp:{path:()=>R(18),security:"none",fp:"chrome",extra:g.ED_PARAMS}}};function N(e,t){return`${e}-${t.toUpperCase()}`}function H({userID:e,address:t,port:a,host:r,path:s,security:i,sni:n,fp:c,alpn:o,extra:d={},name:y}){let p=new URLSearchParams({type:B("d3M="),host:r,path:s});i&&(p.set("security",i),i==="tls"&&p.set("allowInsecure","1")),n&&p.set("sni",n),c&&p.set("fp",c),o&&p.set("alpn",o);for(let[l,u]of Object.entries(d))p.set(l,u);return`${g.VLESS_PROTOCOL}://${e}@${t}:${a}?${p.toString()}#${encodeURIComponent(y)}`}function b({core:e,proto:t,userID:a,hostName:r,address:s,port:i,tag:n}){let c=K[e][t];return H({userID:a,address:s,port:i,host:r,path:c.path(),security:c.security,sni:c.security==="tls"?z(r):void 0,fp:c.fp,alpn:c.alpn,extra:c.extra,name:N(n,t)})}var k=e=>e[Math.floor(Math.random()*e.length)];async function O(e,t,a,r){let i=new URL(e.url).searchParams.get("name"),n={total_TB:380,base_GB:42e3,daily_growth_GB:250,expire_date:"2028-4-20"},c=[r,"creativecommons.org","2027.victoriacross.ir","www.speedtest.net","sky.rethinkdns.com","chat.openai.com","cfip.xxxxxxxx.tk","go.inmobi.com","singapore.com","www.visa.com","www.wto.org","chatgpt.com","yakamoz.nscl.ir","nodejs.org","zzula.ir","csgo.com","fbi.gov"],o=[443,8443,2053,2083,2087,2096],d=[80,8080,8880,2052,2082,2086,2095],y=[],p=r.endsWith(".pages.dev");c.forEach((S,E)=>{y.push(b({core:t,proto:"tls",userID:a,hostName:r,address:S,port:k(o),tag:`Domain${E+1}`})),p||y.push(b({core:t,proto:"tcp",userID:a,hostName:r,address:S,port:k(d),tag:`Domain${E+1}`}))});try{let S=await fetch("https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json");if(S.ok){let E=await S.json();[...E.ipv4||[],...E.ipv6||[]].slice(0,20).map(P=>P.ip).forEach((P,T)=>{let L=P.includes(":")?`[${P}]`:P;y.push(b({core:t,proto:"tls",userID:a,hostName:r,address:L,port:k(o),tag:`IP${T+1}`})),p||y.push(b({core:t,proto:"tcp",userID:a,hostName:r,address:L,port:k(d),tag:`IP${T+1}`}))})}}catch(S){console.error("Fetch IP list failed",S)}let l=1024*1024*1024,u=1024*l,f=n.total_TB*u,h=n.base_GB*l,m=new Date,x=(m.getHours()+m.getMinutes()/60)/24*(n.daily_growth_GB*l),$=h+x/2,C=h+x/2,_=Math.floor(new Date(n.expire_date).getTime()/1e3),A={"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${Math.round(C)}; download=${Math.round($)}; total=${f}; expire=${_}`};return i&&(A["Profile-Title"]=i),new Response(btoa(y.join(`
`)),{headers:A})}async function j(e,t){let a=new WebSocketPair,[r,s]=Object.values(a);s.accept();let i="",n="",c=null,o=(l,u)=>{console.log(`[${i}:${n}] ${l}`,u||"")},d=e.headers.get("Sec-WebSocket-Protocol")||"",y=X(s,d,o),p={value:null};return y.pipeTo(new WritableStream({async write(l,u){if(c)return c.write(l);if(p.value){let S=p.value.writable.getWriter();await S.write(l),S.releaseLock();return}let{hasError:f,message:h,addressType:m,portRemote:U=443,addressRemote:x="",rawDataIndex:$,ProtocolVersion:C=new Uint8Array([0,0]),isUDP:_}=J(l,t.userID);if(i=x,n=`${U}--${Math.random()} ${_?"udp":"tcp"} `,f)throw new Error(h);let D=new Uint8Array([C[0],0]),A=l.slice($);if(_){if(U===53)c=(await ee(s,D,o)).write,c(A);else throw new Error("UDP proxy is only enabled for DNS (port 53)");return}F(p,m,x,U,A,s,D,o,t)},close(){o("readableWebSocketStream closed")},abort(l){o("readableWebSocketStream aborted",l)}})).catch(l=>{console.error("Pipeline failed:",l.stack||l)}),new Response(null,{status:101,webSocket:r})}function G(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function z(e){let t="";for(let a=0;a<e.length;a++)t+=Math.random()<.5?e[a].toUpperCase():e[a].toLowerCase();return t}async function F(e,t,a,r,s,i,n,c,o){async function d(l,u,f=!1){let h;o.socks5Relay?h=await v(t,l,u,c,o.parsedSocks5Address):h=f?await v(t,l,u,c,o.parsedSocks5Address):M({hostname:l,port:u}),e.value=h,c(`connected to ${l}:${u}`);let m=h.writable.getWriter();return await m.write(s),m.releaseLock(),h}async function y(){let l=o.enableSocks?await d(a,r,!0):await d(o.proxyIP||a,o.proxyPort||r,!1);l.closed.catch(u=>console.log("retry tcpSocket closed error",u)).finally(()=>I(i)),W(l,i,n,null,c)}let p=await d(a,r);W(p,i,n,y,c)}function X(e,t,a){return new ReadableStream({start(r){e.addEventListener("message",n=>r.enqueue(n.data)),e.addEventListener("close",()=>{I(e),r.close()}),e.addEventListener("error",n=>{a("webSocketServer has error"),r.error(n)});let{earlyData:s,error:i}=q(t);i?r.error(i):s&&r.enqueue(s)},pull(r){},cancel(r){a(`ReadableStream was canceled, due to ${r}`),I(e)}})}function J(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};let a=new DataView(e),r=a.getUint8(0),s=Z(new Uint8Array(e.slice(1,17)));if(!t.split(",").map(h=>h.trim()).some(h=>s===h))return{hasError:!0,message:"invalid user"};let c=a.getUint8(17),o=a.getUint8(18+c);if(o!==1&&o!==2)return{hasError:!0,message:`command ${o} is not supported`};let d=18+c+1,y=a.getUint16(d),p=a.getUint8(d+2),l,u,f;switch(p){case 1:u=4,f=d+3,l=new Uint8Array(e.slice(f,f+u)).join(".");break;case 2:u=a.getUint8(d+3),f=d+4,l=new TextDecoder().decode(e.slice(f,f+u));break;case 3:u=16,f=d+3,l=Array.from({length:8},(h,m)=>a.getUint16(f+m*2).toString(16)).join(":");break;default:return{hasError:!0,message:`invalid addressType: ${p}`}}return l?{hasError:!1,addressRemote:l,addressType:p,portRemote:y,rawDataIndex:f+u,ProtocolVersion:new Uint8Array([r]),isUDP:o===2}:{hasError:!0,message:`addressValue is empty, addressType is ${p}`}}async function W(e,t,a,r,s){let i=!1;try{await e.readable.pipeTo(new WritableStream({async write(n){if(t.readyState!==g.WS_READY_STATE_OPEN)throw new Error("WebSocket is not open");i=!0;let c=a?await new Blob([a,n]).arrayBuffer():n;t.send(c),a=null},close(){s("Remote connection readable closed.")},abort(n){console.error("Remote connection readable aborted:",n)}}))}catch(n){console.error("RemoteSocketToWS error:",n.stack||n),I(t)}!i&&r&&(s("No incoming data, retrying"),await r())}function q(e){if(!e)return{earlyData:null,error:null};try{let t=atob(e.replace(/-/g,"+").replace(/_/g,"/")),a=new ArrayBuffer(t.length),r=new Uint8Array(a);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return{earlyData:a,error:null}}catch(t){return{earlyData:null,error:t}}}function I(e){try{(e.readyState===g.WS_READY_STATE_OPEN||e.readyState===g.WS_READY_STATE_CLOSING)&&e.close()}catch(t){console.error("safeCloseWebSocket error:",t)}}var w=Array.from({length:256},(e,t)=>(t+256).toString(16).slice(1));function Q(e,t=0){return(w[e[t]]+w[e[t+1]]+w[e[t+2]]+w[e[t+3]]+"-"+w[e[t+4]]+w[e[t+5]]+"-"+w[e[t+6]]+w[e[t+7]]+"-"+w[e[t+8]]+w[e[t+9]]+"-"+w[e[t+10]]+w[e[t+11]]+w[e[t+12]]+w[e[t+13]]+w[e[t+14]]+w[e[t+15]]).toLowerCase()}function Z(e,t=0){let a=Q(e,t);if(!G(a))throw new TypeError("Stringified UUID is invalid");return a}async function ee(e,t,a){let r=!1,s=new TransformStream({transform(n,c){for(let o=0;o<n.byteLength;){let d=n.slice(o,o+2),y=new DataView(d).getUint16(0),p=new Uint8Array(n.slice(o+2,o+2+y));o=o+2+y,c.enqueue(p)}}});s.readable.pipeTo(new WritableStream({async write(n){try{let o=await(await fetch("https://1.1.1.1/dns-query",{method:"POST",headers:{"content-type":"application/dns-message"},body:n})).arrayBuffer(),d=o.byteLength,y=new Uint8Array([d>>8&255,d&255]);e.readyState===g.WS_READY_STATE_OPEN&&(r?e.send(await new Blob([y,o]).arrayBuffer()):(e.send(await new Blob([t,y,o]).arrayBuffer()),r=!0))}catch(c){a("DNS query error: "+c)}}})).catch(n=>a("DNS stream error: "+n));let i=s.writable.getWriter();return{write:n=>i.write(n)}}async function v(e,t,a,r,s){let{username:i,password:n,hostname:c,port:o}=s,d=M({hostname:c,port:o}),y=d.writable.getWriter(),p=d.readable.getReader(),l=new TextEncoder;await y.write(new Uint8Array([5,2,0,2]));let u=(await p.read()).value;if(u[0]!==5||u[1]===255)throw new Error("SOCKS5 server connection failed.");if(u[1]===2){if(!i||!n)throw new Error("SOCKS5 auth credentials not provided.");let m=new Uint8Array([1,i.length,...l.encode(i),n.length,...l.encode(n)]);if(await y.write(m),u=(await p.read()).value,u[0]!==1||u[1]!==0)throw new Error("SOCKS5 authentication failed.")}let f;switch(e){case 1:f=new Uint8Array([1,...t.split(".").map(Number)]);break;case 2:f=new Uint8Array([3,t.length,...l.encode(t)]);break;case 3:f=new Uint8Array([4,...t.split(":").flatMap(m=>[parseInt(m.slice(0,2),16),parseInt(m.slice(2),16)])]);break;default:throw new Error(`Invalid addressType for SOCKS5: ${e}`)}let h=new Uint8Array([5,1,0,...f,a>>8,a&255]);if(await y.write(h),u=(await p.read()).value,u[1]!==0)throw new Error("Failed to open SOCKS5 connection.");return y.releaseLock(),p.releaseLock(),d}function te(e){try{let[t,a]=e.includes("@")?e.split("@"):[null,e],[r,s]=a.split(":"),i=parseInt(s,10);if(!r||isNaN(i))throw new Error;let n,c;if(t&&([n,c]=t.split(":"),!n))throw new Error;return{username:n,password:c,hostname:r,port:i}}catch{throw new Error("Invalid SOCKS5 address format.")}}async function re(e,t){let r=new URL(e.url).searchParams.get("ip");if(!r)return new Response(JSON.stringify({error:"Missing IP"}),{status:400,headers:{"Content-Type":"application/json"}});let{username:s,apiKey:i,baseUrl:n}=t.scamalytics;if(!s||!i)return new Response(JSON.stringify({error:"Scamalytics API not configured"}),{status:500,headers:{"Content-Type":"application/json"}});let c=`${n}${s}/?key=${i}&ip=${r}`,o=new Headers({"Content-Type":"application/json","Access-Control-Allow-Origin":"*"});try{let y=await(await fetch(c)).json();return new Response(JSON.stringify(y),{headers:o})}catch(d){return new Response(JSON.stringify({error:d.toString()}),{status:500,headers:o})}}async function ae(e,t,a){let r=b({core:"xray",proto:"tls",userID:e,hostName:t,address:t,port:443,tag:`${t}-Xray`}),s=b({core:"sb",proto:"tls",userID:e,hostName:t,address:t,port:443,tag:`${t}-Singbox`}),i=encodeURIComponent("INDEX"),n=`https://${t}/xray/${e}?name=${i}`,c=`https://${t}/sb/${e}?name=${i}`;try{let o=await fetch(V);if(!o.ok)throw new Error(`Failed to load HTML from GitHub Pages: ${o.status}`);let d=await o.text();return d=d.replace(/{{PROXY_ADDRESS}}/g,a).replace(/{{CONFIG_DREAM}}/g,r).replace(/{{CONFIG_FREEDOM}}/g,s).replace(/{{URL_HIDDIFY}}/g,`hiddify://install-config?url=${encodeURIComponent(n)}`).replace(/{{URL_V2RAYNG}}/g,`v2rayng://install-config?url=${encodeURIComponent(n)}#${i}`).replace(/{{URL_CLASH}}/g,`clash://install-config?url=${encodeURIComponent(`https://revil-sub.pages.dev/sub/clash-meta?url=${c}`)}`).replace(/{{URL_EXCLAVE}}/g,`sn://subscription?url=${encodeURIComponent(c)}&name=${i}`),new Response(d,{headers:{"Content-Type":"text/html; charset=utf-8"}})}catch(o){return new Response(`Error rendering panel: ${o.message}`,{status:500,headers:{"Content-Type":"text/plain"}})}}var oe={async fetch(e,t,a){try{let r=Y.fromEnv(t),s=new URL(e.url),i=e.headers.get("Upgrade");if(i&&i.toLowerCase()==="websocket"){let n={userID:r.userID,proxyIP:r.proxyIP,proxyPort:r.proxyPort,socks5Address:r.socks5.address,socks5Relay:r.socks5.relayMode,enableSocks:r.socks5.enabled,parsedSocks5Address:r.socks5.enabled?te(r.socks5.address):{}};return j(e,n)}return s.pathname==="/scamalytics-lookup"?re(e,r):s.pathname.startsWith(`/xray/${r.userID}`)?O(e,"xray",r.userID,s.hostname):s.pathname.startsWith(`/sb/${r.userID}`)?O(e,"sb",r.userID,s.hostname):s.pathname.startsWith(`/${r.userID}`)?ae(r.userID,s.hostname,r.proxyAddress):new Response("UUID not found. Please set the UUID environment variable in the Cloudflare dashboard.",{status:404})}catch(r){return new Response(`Worker Logic Error: ${r.message}
${r.stack}`,{status:500,headers:{"Content-Type":"text/plain"}})}}};export{oe as default};
